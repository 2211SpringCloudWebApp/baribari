<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>BARIBARI</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Favicon-->
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
    <!-- Fontawesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
    <!-- Bootstrap Style -->
   	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <!-- Bootstrap icons-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" />
    <!-- Core theme CSS (includes Bootstrap)-->
    <link href="../../../css/shopping/style.css" rel="stylesheet" />
    <!-- IBM Plex Sans KR font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+KR:wght@300&display=swap" rel="stylesheet">
    <!-- JQuery JS -->
	<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
	<!-- Bootstrap JS -->
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
	
    <link href="../../../css/shopping/cart.css" rel="stylesheet" />
</head>
<body>
<!-- Header -->
<!-- <header th:replace="header :: header"></header> -->

<section class="shopping-cart dark">
    <!-- 상단 이미지 -->
    <div class="bg-dark py-5">
        <div class="container px-4 px-lg-5 my-5">
			<div class="text-center text-white">
			    장바구니 사진이 들어가는 위치
			</div>
        </div>
    </div>
    
	<div class="container">
	    <div class="block-heading">
			<h2 th:text="|${user.userName} 님의 장바구니|"></h2>
	    </div>
	    <div class="content">
			<div class="row">
				<div class="col-md-12 col-lg-8">
					<div class="col-md-12 items">
 						
						<!-- 상품 목록 -->
		 				<div class="product" th:each="product : ${pList}">
		 					<div class="row">
		 						<div class="col-md-1">
		 							<input type="checkbox">
		 						</div>
		 						<!-- 상품 사진 -->
			 					<div class="col-md-3">
			 						<img th:src="@{'../../../img/logo.png'}" class="card-img-top" alt="제품사진" />
			 					</div>
			 					<div class="col-md-8">
			 						<div class="info">
				 						<div class="row">
			 								<!-- 상품명 -->
					 						<div class="col-md-5 product-name">
						 						<a th:href="@{'/shopping/detail?productNo=' + ${product.productNo}}"  th:text="${product.productName}"></a>
					 						</div>
					 						<!-- 구매수량, 수량이 변함에 따라 총 가격이 달라짐 -->
					 						<div class="col-md-3 quantity">
											    <label for="quantity">수량</label>
											    <input th:value="${product.productQuantity}" id="quantity" class="form-control quantity-input" type="number" oninput="updateTotalPrice(&quot;${product.productPrice}&quot;, &quot;${product.productDiscount}&quot;)">
											</div>
					 						<!-- 상품가, productDiscount가 있으면 정가에 취소선/할인가 출력 -->
					 						<div class="col-md-3">
					 							<span id="price" th:if="${product != null and product.productDiscount == 0}" th:text="|${#numbers.formatInteger(product.productPrice, 0, 'COMMA')}원|">상품가격</span>
												<span th:if="${product != null and product.productDiscount != 0}" th:text="|${#numbers.formatInteger(product.productPrice, 0, 'COMMA')}원|" class="text-muted text-decoration-line-through">상품가격 취소선</span><br>
												<span id="price" th:if="${product != null and product.productDiscount != 0}" th:text="|${#numbers.formatInteger(product.productPrice - product.productDiscount * product.productPrice / 100, 0, 'COMMA')}원|">할인된 가격</span>
												<input th:value="${product.productPrice * product.productDiscount / 100}" id="discount" type="hidden">
					 						</div>
					 						<div class="col-md-1">
					 							<span class="btn btn-outline-dark mt-auto" href="#" th:onclick="'removeFromCart(\'' + ${product.productNo} + '\')'">
					                        		<i class="fa fa-times"></i>
				                        		</span>
					 						</div>
					 					</div>
					 				</div>
			 					</div>
			 				</div>
			 				<!-- 상품 가격 -->
		 					<div class="col-md-12 price">
		 					<hr>
	 							상품가격 <span th:text="|${#numbers.formatInteger(product.productPrice * product.productQuantity, 0, 'COMMA')}|" id="product-price"></span>원
	 							- 할인가격 <span th:text="|${#numbers.formatInteger((product.productPrice * product.productDiscount / 100) * product.productQuantity, 0, 'COMMA')}|" id="product-discount"></span>원
	 							+ 배송비 <span id="delivery-price">3,000</span>
	 							= <span id="total-price-by-product">총 가격</span>원
	 						</div>
		 				</div>
			 				
		 			</div>
	 			</div>
	 			
	 			<!-- 가격/결제 -->
	 			<div class="col-md-12 col-lg-4">
	 				<div class="summary">
	 					<h3>가격</h3>
	 					<div class="summary-item"><span class="text">상품 가격</span><span id="total-price" class="price">123,456 원</span></div>
	 					<div class="summary-item"><span class="text">총 할인</span><span class="price">12,345 원</span></div>
	 					<div class="summary-item"><span class="text">배송비</span><span class="price">12,345 원</span></div>
	 					<div class="summary-item"><span id="total-price" class="text">총 가격</span><span class="price">123,456 원</span></div>
	 					<button type="button" class="btn btn-primary btn-lg btn-block">결제하기</button>
		 			</div>
	 			</div>
	 			
 			</div> 
 		</div>
	</div>
</section>

<!-- Footer -->
<footer th:replace="footer :: footer"></footer>
<script>

	var userNo = [[${user.userNo}]];
	
	updateTotalPrice();

	function updateTotalPrice(price, discount) {
		  const quantity = document.getElementById('quantity').value;
		  const productPrice = document.querySelector('#price').textContent.replace(/[,원]/g, '') * quantity; // 가격 - ','와 '원' 제거
		  const discountPrice = document.querySelector('#discount').value * quantity;
		  const totalPrice = productPrice - discountPrice + 3000;
		  document.getElementById('product-price').textContent = numberWithCommas(productPrice);
		  document.getElementById('product-discount').textContent = numberWithCommas(discountPrice);
		  document.getElementById('total-price-by-product').textContent = numberWithCommas(totalPrice);
	}

	function numberWithCommas(number) {
		return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
	}
	
	/* 상품을 장바구니에서 제거 */
	function removeFromCart(productNo) {
		var confirmed = confirm("정말로 삭제하시겠습니까?");
		if (!confirmed) {
			return;
		}
		$.ajax({
		      type: "POST",
		      url: "/cart/remove",
		      data: {
		      	"userNo": userNo,
		      	"productNo": productNo
		      },
		      success: function(result) {
		    	  if (result == "1") {
		    		  alert("삭제 완료");
		    		  location.reload();
		    	  } else {
				      alert("삭제 실패");
				      console.log(result);
		    	  }
		      },
		      error: function() {
		    	  alert("처리 실패");
		      }
		});
	}
		  
</script>
	
</body>
</html>