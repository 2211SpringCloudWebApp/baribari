<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
	<head>
		<meta charset="UTF-8">
		<title>게시글 등록</title>
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reset-css@5.0.1/reset.min.css">
		<link href="../../../css/community/board/detail.css" rel="stylesheet">
		<script src="https://code.jquery.com/jquery-3.6.3.min.js"></script>
		
		<!-- Favicons -->
		<link href="assets/img/favicon.png" rel="icon">
		<link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">
		
		  <!-- Google Fonts -->
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+KR:wght@200&display=swap" rel="stylesheet">
		
		<!-- Vendor CSS Files -->
		<link href="assets/vendor/animate.css/animate.min.css" rel="stylesheet">
		<link href="assets/vendor/aos/aos.css" rel="stylesheet">
		<link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
		<link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
		<link href="assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
		<link href="assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">
		<link href="assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">
		
		<!-- Template Main CSS File -->
		<link href="assets/css/style.css" rel="stylesheet">
	</head>
	<body>
        <header>
        	<div th:replace="header.html :: header"></div>
        </header>
        
        <form action="/boardRegister" method="post" onsubmit="return validateForm()">
            <div id="registerContainer">
                <div id="registerdiv1">
                    상세보기
                </div>

                <div id="registerdiv2">
                    <div id="registerdiv2-1">
                    	<input type="text" readonly th:value="${commu.communityCategory == 0 ? '잡담' : commu.communityCategory == 1 ? '캠핑지' : ''}">
                    </div>
                    <div id="registerdiv2-2">
                        <input id="inputSubject" readonly name="subject" th:value="${commu.communitySubject}">
                        <input type="hidden" name="userNo" value = "45"/>
	                    <input type="hidden" id="seq" name="seq" th:value="${commu.communityNo}" />
                    </div>
                </div>

                <div id="registerdiv6" >
                    <div id="map" ></div>
                    <input type="hidden" id="mapXval" name="mapX" th:value="${commu.mapX}">
	                <input type="hidden" id="mapYval" name="mapY" th:value="${commu.mapY}">
                </div>
     
                <div id="registerdiv3"></div>
                <div id="registerdiv7" data-placeholder='사진을 첨부 하려면 파일 선택 버튼을 클릭하거나 파일을 드래그앤드롭 하세요'>

                </div>
                
                <script>
                	
                  
                (// 이미지를 보여주는 영역 설정.
                        imageView = function imageView(registerdiv7, btn){

                            var attZone = document.getElementById(registerdiv7);
                            var fileUpload = document.getElementById(btn)
                            var sel_files = [];
                            var showimg = document.getElementById(showimg); // 테스트로 이미지값 보여줄곳
                            // 이미지와 체크 박스를 감싸고 있는 div 속성
                            var div_style = 'display:inline-block;position:relative;'
                                        + 'width:90px;height:90px;'
                                        + 'position: relative; display: inline-block;';
                            // 겹쳐지는 div 스타일 속성
                            var over_style = 'position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 0, 0, 0.5); display:none'
                                        + 'align-items: center; justify-content: center; font-size:30px; color:rgb(255, 255, 255)';
                            // 미리보기 이미지 속성
                            var img_style = 'width:90px;height:90px;z-index:none';
                            // 이미지안에 표시되는 체크박스의 속성
                            var chk_style = 'width:30px;height:30px;position:absolute;font-size:24px;'
                                        + 'right:0px;bottom:0px;z-index:999;background-color:rgba(255,255,255,0.1);color:#f00';

                            fileUpload.onchange = function(e){ // 파일 선택이 변경되면 실행될 함수를 등록합니다.
                                var files = e.target.files; // 선택한 파일 목록을 변수에 할당합니다.
                                var fileArr = Array.prototype.slice.call(files) // 파일 목록을 배열로 변경하여 변수에 할당합니다.
                                for(f of fileArr){ // 파일 목록을 순환하면서 imageLoader 함수를 실행합니다.
                                    imageLoader(f);
                                }
                            }


                            // 탐색기에서 드래그앤 드롭 사용
                            // 드래그 앤 드롭 영역에 마우스가 진입하면 실행
                            attZone.addEventListener('dragenter', function(e){ 
                                e.preventDefault(); // 기본 이벤트 중지
                                e.stopPropagation();    // 이벤트 실행 중지
                            }, false)
                        
                            // 드래그한 파일을 영역 위에 놓을 때 실행
                            attZone.addEventListener('dragover', function(e){
                                e.preventDefault(); // 기본 이벤트 중지
                                e.stopPropagation();    // 이벤트 실행 중지
                            }, false)

                            // 파일을 영역에 드롭했을 때 실행
                            attZone.addEventListener('drop', function(e){
                                var files = {}; // 이미지 저장할 객체 생성
                                e.preventDefault(); // 기본 이벤트 중지
                                e.stopPropagation();    // 이벤트 실행 중지
                                var dt = e.dataTransfer;    //
                                files = dt.files;   // 드롭한 이미지 변수 할당
                                for(f of files){    // files 순회하면서 imageLoader 함수 실행
                                    imageLoader(f);
                                }
                            }, false)

                            /*첨부된 이미리즐을 배열에 넣고 미리보기 */
                            imageLoader = function(file){
                                sel_files.push(file);   // 배열에 이미지 저장
                                var reader = new FileReader();  // 이미지 불러올 변수 생성
                                reader.onload = function(ee){   // 이미지 로드될때 실행되는 함수 정의
                                    let img = document.createElement('img') // img 태그 생성
                                    img.setAttribute('style', img_style)    // 스타일 적용
                                    img.src = ee.target.result; // 이미지 소스 설정
                                    attZone.appendChild(makeDiv(img, file));    // 미리보기 div 생성 후 이미지 추가
                                }
                                reader.readAsDataURL(file); // 파일 읽어와서 이미지 소스로 설정
                            }

                            /*첨부된 파일이 있는 경우 checkbox와 함께 attZone에 추가할 div를 만들어 반환 */
                            makeDiv = function(img, file){
                                var div = document.createElement('div'); // div 태그 생성
                                div.setAttribute('style', div_style); // div 태그에 스타일 설정

                                var overlay = document.createElement('div'); // overlay div 태그 생성
                                overlay.setAttribute('style', over_style); // div 태그에 스타일 설정
                                overlay.innerHTML = '삭제';

                                // 마우스를 영역에 올렸을때 실행
                                div.onmouseover = function() { // div 태그에 마우스 오버 이벤트 핸들러 등록
                                    overlay.style.display ='flex';
                                    overlay.onclick = function(ev){
                                    var ele = ev.srcElement;
                                    var delFile = ele.getAttribute('delFile');
                                    for(var i=0 ;i<sel_files.length; i++){
                                        if(delFile== sel_files[i].name){
                                            sel_files.splice(i, 1);      
                                        }
                                    }
                                    
                                    dt = new DataTransfer();
                                    for(f in sel_files) {
                                        var file = sel_files[f];
                                        dt.items.add(file);
                                    }
                                    fileUpload.files = dt.files;
                                    var p = ele.parentNode;
                                    attZone.removeChild(p)
                                }
                                    div.appendChild(overlay); // div 태그에 overlay div 추가
                                };
                                // 마우스가 영역을 나갔을 때 실행
                                div.onmouseout = function() {overlay.style.display ='none';}

                                var imgDiv = document.createElement('div'); // imgDiv div 태그 생성
                                imgDiv.appendChild(img); // imgDiv div 태그에 이미지 추가
                                div.appendChild(imgDiv); // div 태그에 imgDiv div 추가
                                return div; // 완성된 div 태그 반환
                            }
                        }
                    )('registerdiv7', 'fileUpload')
                  
	              	//사진 추가하는 부분
	              	$(document).ready(function() { // 문서 로딩이 완료되면 실행하는 함수
	              		$('#fileUpload').on('change', function() { // 파일 선택이 변경되면 실행하는 함수
	              			const fileList = document.querySelector("#fileUpload").files;	//파일 리스트 가져오기
	              			if (fileList.length > 0) {// 파일이 선택되었는지 확인합니다.
	              				const formData = new FormData(); // FormData 객체를 생성합니다.
	              				for (let i = 0; i < fileList.length; i++) { //formData에 사진 리스트를 넣음
	 	  	            			formData.append("fileList", fileList[i]);
	 	  	            		}
	              			}
	              		});
	              	});
                
                </script>
                <div id="registerdiv4">
                    <textarea name="content" id="inputContent" readonly th:text=${commu.communityContent} ></textarea>
                </div>
                <div id="registerdiv5">
                    <div id="showTage" ></div>
                </div>
                <div id="registerdiv9">
                    <input type="submit">
                    <input type="reset">
                </div>
            </div>
        </form>

        <script type="text/javascript"
        src="//dapi.kakao.com/v2/maps/sdk.js?appkey=ba03b0afa21d048313b9d7072d06edb9&libraries=services"></script>
        <script type="text/javascript"
            src="//dapi.kakao.com/v2/maps/sdk.js?appkey=ba03b0afa21d048313b9d7072d06edb9"></script>
        <script>
        

        
        // 지도를 출력하는 함수
        function createMap(x, y) {
            var mapContainer = document.getElementById('map'), // 지도를 표시할 div 
                mapOption = {
                    center: new kakao.maps.LatLng(y, x), // 지도의 중심좌표
                    level: 3 // 지도의 확대 레벨
                };
            var map = new kakao.maps.Map(mapContainer, mapOption); // 지도를 생성합니다
            // 마커를 표시할 위치입니다 
            var position = new kakao.maps.LatLng(y, x);
            // 마커를 생성합니다
            var marker = new kakao.maps.Marker({
                position: position
            });
            // 마커를 지도에 표시합니다.
            marker.setMap(map);
            // 마커에 커서가 오버됐을 때 마커 위에 표시할 인포윈도우를 생성합니다
            var iwContent = '<div style="padding:5px;">'+'</div>'; // 인포윈도우에 표출될 내용으로 HTML 문자열이나 document element가 가능합니다
            // 인포윈도우를 생성합니다
            var infowindow = new kakao.maps.InfoWindow({
                content: iwContent
            });
            // 마커에 마우스오버 이벤트를 등록합니다
            kakao.maps.event.addListener(marker, 'mouseover', function () {
                // 마커에 마우스오버 이벤트가 발생하면 인포윈도우를 마커위에 표시합니다
                infowindow.open(map, marker);
            });
            // 마커에 마우스아웃 이벤트를 등록합니다
            kakao.maps.event.addListener(marker, 'mouseout', function () {
                // 마커에 마우스아웃 이벤트가 발생하면 인포윈도우를 제거합니다
                infowindow.close();
            });
        }
        
        //지도 출력을 위해 값 받아오기
        var x = document.getElementById('mapXval').value
        var y = document.getElementById('mapYval').value
        comsloe.log(x);
        
        // 지도 출력
        if (x !== 0 && y !== 0) {
        	document.getElementById('registerdiv6').style.display = 'block';
        	createMap(x, y);
        }
        
        	getHashTag();
	        // 헤시태그 출력 함수
	        function getHashTag(){
	        	var communityNo = $("#seq").val();
	        	var showTage = $("#showTage");
	        	var inputTage = document.getElementById('inputTage');
	        	var scrollTop = $(window).scrollTop(); // 스크롤위치 저장
	        	$.ajax({
	        		url : "getHashTag",
	        		data : {
	        			"communityNo": communityNo
	        			},
	        		type : "GET",
	        		success : function(data){
	        			showTage.empty(); // 기존 내용 삭제
	        		    for (var i = 0; i < data.length; i++) {
	        		    	var tag = $("<a>").attr({
	        		    		href : "#",
	        		    		onclick: "registerHashTag('" + data[i].hashTagName + "', " + getHashTag + ", 'delete')"
	        		    	}).text(data[i].hashTagName); // 새로운 a 태그 생성
	        		    	showTage.append(tag); // 새로운 a 태그를 요소에 추가
	        			}
	        		    if (data.length == 10){
	        		        inputTage.readOnly = true; // inputTage를 읽기전용으로 설정
	        		        inputTage.placeholder = "해시태그는 10개까지 등록이 가능합니다."; // placeholder를 "해시태그는 10개까지 등록이 가능합니다." 로 설정
	        		    }else{
	        		    	inputTage.readOnly = false;
	        		    	inputTage.placeholder = "#해시태그, 입력";
	        		    }
	        		    $(window).scrollTop(scrollTop);//스크롤위치 다시 불러오기
	        		},
	        		error : function(){
	        			showTage.empty();
	        		}
	        	});
	        }
        </script>
        <footer>
            <div th:replace="footer.html :: footer"></div>
        </footer>
    </body>
</html>