<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="" />
    <meta name="author" content="" />

    <title>BARIBARI</title>

    <!-- JQuery JS -->
	<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
	<!-- Bootstrap JS -->
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
	
    <!-- Favicon-->
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
    <!-- Fontawesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
    <!-- Bootstrap Style -->
   	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <!-- Bootstrap icons-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" />
    <!-- Core theme CSS (includes Bootstrap)-->
    <link href="../../css/shopping/style.css" rel="stylesheet" />
    <!-- IBM Plex Sans KR font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+KR:wght@300&display=swap" rel="stylesheet">
    <!-- Template Main CSS File -->
    <link href="../../assets/css/style.css" rel="stylesheet">
	
    <link href="../../css/shopping/cart.css" rel="stylesheet" />
</head>
<body>
<!-- Header -->
<header th:replace="header :: header"></header>

<section class="shopping-cart dark" style="margin-top: 110px;">
    <!-- 상단 이미지 -->
    <div class="bg-dark py-5">
        <div class="container px-4 px-lg-5 my-5">
			<div class="text-center text-white">
			    장바구니 사진이 들어가는 위치
			</div>
        </div>
    </div>
    
	<div class="container">
	    <div class="block-heading">
			<h2 th:text="|${user.userName} 님의 장바구니|"></h2>
	    </div>
	    <div class="content">
			<div class="row">
				<div class="col-md-12 col-lg-7 delivery-info">
					<div class="col-md-12 items">
 						
						<!-- 상품 목록 -->
		 				<div class="product" th:each="product, i : ${pList}">
		 					<div class="row">
		 						<div class="col-md-1">
		 							<input type="checkbox" id="product-${i.index}" onclick="calculateTotalPrice()">
		 						</div>
		 						<!-- 상품 사진 -->
			 					<div class="col-md-3">
			 						<img th:src="@{'../../../img/logo.png'}" class="card-img-top" alt="제품사진" />
			 					</div>
			 					<div class="col-md-8">
			 						<div class="info">
				 						<div class="row">
			 								<!-- 상품명 -->
					 						<div class="col-md-5 product-name">
						 						<a th:href="@{'/shopping/detail?productNo=' + ${product.productNo}}"  th:text="${product.productName}"></a>
					 						</div>
					 						<!-- 구매수량, 수량이 변함에 따라 총 가격이 달라짐 -->
					 						<div class="col-md-3 quantity">
											    <label for="quantity">수량</label>
											    <input th:value="${product.productQuantity}" th:id="|quantity-${i.index}|" class="form-control quantity-input" type="number" th:oninput="|updateTotalPrice(${product.productPrice}, ${i.index})|" style="margin-bottom: 10px;">
											    <div class="col-md-1" style="display: contents;">
					 							<span id="btn-updateQuantity" class="btn btn-outline-dark mt-auto" href="#" th:onclick="|updateQuantity(${product.productNo}, ${i.index})|">수정</span>
					 						</div>
											</div>
					 						<!-- 상품가, productDiscount가 있으면 정가에 취소선/할인가 출력 -->
					 						<div class="col-md-3">
					 							<span th:if="${product.productDiscount == 0}" th:text="|${#numbers.formatInteger(product.productPrice, 0, 'COMMA')}원|" th:id="|price-${i.index}|">상품가격</span>
												<span th:if="${product.productDiscount != 0}" th:text="|${#numbers.formatInteger(product.productPrice, 0, 'COMMA')}원|" class="text-muted text-decoration-line-through">상품가격 취소선</span><br>
												<span th:if="${product.productDiscount != 0}" th:text="|${#numbers.formatInteger(product.productPrice - product.productDiscount * product.productPrice / 100, 0, 'COMMA')}원|" th:id="|price-${i.index}|">할인된 가격</span>
												<input th:value="${product.productPrice * product.productDiscount / 100}" th:id="|discount-${i.index}|" type="hidden">
					 						</div>
					 						<div class="col-md-1">
					 							<span class="btn btn-outline-dark mt-auto" href="#" th:onclick="'removeFromCart(\'' + ${product.productNo} + '\')'">
					                        		<i class="fa fa-times"></i>
				                        		</span>
					 						</div>
					 					</div>
					 				</div>
			 					</div>
			 				</div>
			 				<!-- 상품 가격 -->
		 					<div class="col-md-12 price">
		 					<hr>
	 							상품가격 <span th:text="|${#numbers.formatInteger(product.productPrice * product.productQuantity, 0, 'COMMA')}|" th:id="|product-price-${i.index}|"></span>원
	 							- 할인가격 <span th:text="|${#numbers.formatInteger((product.productPrice * product.productDiscount / 100) * product.productQuantity, 0, 'COMMA')}|" th:id="|product-discount-${i.index}|"></span>원
	 							+ 배송비 <span th:text="|${#numbers.formatInteger(product.productDeliveryCharge, 0, 'COMMA')}|" th:id="|delivery-charge-${i.index}|"></span>원
	 							= <span th:id="|total-price-by-product-${i.index}|">총 가격</span>원
	 						</div>
		 				</div>
			 				
		 			</div>
	 			</div>
	 			
	 			<!-- 가격/결제 -->
	 			<div class="col-md-12 col-lg-4 payment-info" id="payment-info">
	 				<div class="summary">
	 					<h3>가격</h3>
	 					<div class="summary-item"><span class="text">상품 가격</span><span id="total-price" class="price"></span></div>
	 					<div class="summary-item"><span class="text">총 할인</span><span id="total-discount" class="price"></span></div>
	 					<div class="summary-item"><span class="text">배송비</span><span id="total-delivery-charge" class="price"></span></div>
	 					<div class="summary-item"><span class="text">총 가격</span><span id="payment-price" class="price"></span></div>
	 					<button type="button" class="btn btn-primary btn-lg btn-block" onclick="payment()">결제하기</button>
		 			</div>
	 			</div>
	 			
			</div>	 			
 		</div>
	</div>
</section>

<!-- Footer -->
<footer th:replace="footer :: footer"></footer>
<script>

	var userNo = [[${user.userNo}]];
	
	// 페이지가 로드될 때 실행되는 함수
	window.onload = function() {
	  // 모든 수량 입력 필드의 값을 1로 초기화
	  const quantity = document.querySelectorAll('#quantity-input-');
	  for (let i = 0; i < quantityInputs.length; i++) {
	    quantityInputs[i].value = 1;
	    // 초기화된 수량으로 총 결제금액 등을 계산
	    updateTotalPrice(parseInt(document.querySelector('#price-' + i).textContent.replace(/[^0-9]/g,'')), i);
	  }
	};
	
	// 해당 상품 가격 정보
	function updateTotalPrice(price, index) { // 해당 상품의 원래 가격, index
		const quantity = parseInt(document.querySelector('#quantity-' + index).value); // 해당 상품의 선택 수량
		const productPrice = parseInt(document.querySelector('#price-' + index).textContent.replace(/[^0-9]/g,'')) * quantity; // 할인 적용된 가격, 가격 - ','와 '원' 제거
		const discountPrice = parseInt(document.querySelector('#discount-' + index).value) * quantity; // 해당 상품 총 할인금액
		const deliveryCharge = parseInt(document.querySelector('#delivery-charge-' + index).textContent.replace(/[^0-9]/g,''));
		const totalPrice = parseInt(productPrice + deliveryCharge);
		document.querySelector('#product-price-' + index).textContent = numberWithCommas(price * quantity);
		document.querySelector('#product-discount-' + index).textContent = numberWithCommas(discountPrice);
  		document.querySelector('#total-price-by-product-' + index).textContent = numberWithCommas(totalPrice);
	}
	// 자릿수 콤마z
	function numberWithCommas(number) {
		return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
	}
	
	
	/* 상품 수량 변경 */
	function updateQuantity(productNo, index) {
		const quantity = parseInt(document.querySelector('#quantity-' + index).value); // 해당 상품의 선택 수량
		console.log(userNo + ", " + productNo + ", " + quantity + ", ");
		$.ajax({
			type: "POST",
			url: "/cart/update",
			data: {
				"userNo": userNo,
				"productNo": productNo,
				"productQuantity": quantity
			},
			success: function(result) {
				if (result == "1") {
					alert("수정 완료");
					location.reload();
				} else {
					alert("수정 실패");
					console.log(result);
				}
			},
			error: function() {
				alert("처리 실패");
			}			
		});
	}
	
	function calculateTotalPrice() {
		  let totalPrice = 0;
		  const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
		  checkboxes.forEach(function (checkbox) {
		    const index = checkbox.id.split('-')[1];
		    const productPrice = parseInt(document.getElementById(`product-price-${index}`).textContent.replace(/,/g, ''));
		    totalPrice += productPrice;
		  });
		  console.log(totalPrice);
		}

		const checkboxes = document.querySelectorAll('input[type="checkbox"]');
		checkboxes.forEach(function (checkbox) {
		  checkbox.addEventListener('click', calculateTotalPrice);
		});

		
	/* 상품을 장바구니에서 제거 */
	function removeFromCart(productNo) {
		var confirmed = confirm("정말로 삭제하시겠습니까?");
		if (!confirmed) {
			return;
		}
		$.ajax({
		      type: "POST",
		      url: "/cart/remove",
		      data: {
		      	"userNo": userNo,
		      	"productNo": productNo
		      },
		      success: function(result) {
		    	  if (result == "1") {
		    		  alert("삭제 완료");
		    		  location.reload();
		    	  } else {
				      alert("삭제 실패");
				      console.log(result);
		    	  }
		      },
		      error: function() {
		    	  alert("처리 실패");
		      }
		});
	}
		  
</script>
	
</body>
</html>